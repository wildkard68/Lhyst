<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#6366F1" />
    <meta property="og:image" content="./assets/icon-512.upperleft.v1.png" />

  <link rel="manifest" href="./manifest.webmanifest" />

      <link rel="icon" sizes="16x16" href="./assets/favicon-16.upperleft.v1.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="./assets/favicon-16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="./assets/apple-touch-icon.upperleft.v1.png" />
    <link rel="icon" href="./favicon.upperleft.v1.ico" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <title>Lhyst</title>
  <style>
    :root{
      color-scheme: light;
      --bg: #f8fafc;
      --bg-accent: radial-gradient(900px 400px at 15% -10%, rgba(99,102,241,.12), transparent 60%), radial-gradient(700px 400px at 85% 0%, rgba(34,197,94,.10), transparent 55%);
      --surface: #ffffff;
      --muted: #f3f4f6;
      --line: #e5e7eb;
      --text: #0f172a;
      --subtle: #475569;
      --brand: #6366F1; /* indigo-500 */
      --brand-ink: #4338CA; /* indigo-700 */
      --accent: #22C55E; /* emerald-500 */
      --warn: #EAB308;
      --danger: #EF4444;
      --radius: 16px;
      --radius-sm: 12px;
      --shadow: 0 12px 30px rgba(2,6,23,.08);
      --ring: 0 0 0 4px rgba(99,102,241,.18);
      --ring-green: 0 0 0 4px rgba(34,197,94,.18);
      --surface-soft: #fbfdff;
      --table-head: #f1f5ff;
      --table-head-line: #e0e7ff;
      --tab-bg: #eef2ff;
      --tab-ink: #312e81;
      --popover: #ffffff;
    }
    html[data-theme="dark"]{
      color-scheme: dark;
      --bg: #0b1220;
      --bg-accent: radial-gradient(900px 400px at 15% -10%, rgba(99,102,241,.20), transparent 60%), radial-gradient(700px 400px at 85% 0%, rgba(34,197,94,.14), transparent 55%);
      --surface: #0f172a;
      --muted: #0b162b;
      --line: #1f2937;
      --text: #e5e7eb;
      --subtle: #9ca3af;
      --brand: #8b8cf6;
      --brand-ink: #6366f1;
      --accent: #34d399;
      --warn: #f59e0b;
      --danger: #f87171;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --ring: 0 0 0 4px rgba(139,140,246,.22);
      --ring-green: 0 0 0 4px rgba(52,211,153,.20);
      --surface-soft: #0b1220;
      --table-head: #121a2b;
      --table-head-line: #1c2540;
      --tab-bg: #1a2340;
      --tab-ink: #c7d2fe;
      --popover: #0f172a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background: var(--bg-accent), var(--bg);
    }
    header{
      position:sticky; top:0; z-index:20;
      backdrop-filter: saturate(1.4) blur(10px);
      background: color-mix(in srgb, var(--surface) 70%, transparent);
      border-bottom: 1px solid var(--line);
      color:var(--text);
      padding: 10px 16px;
      display:flex; align-items:center; gap:12px;
    }
    header h1{font-size:18px;margin:0;font-weight:800;letter-spacing:.2px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand-badge{
      width:28px;height:28px;border-radius:10px;
      background: linear-gradient(180deg, var(--brand), var(--brand-ink));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.25), 0 4px 10px rgba(17,24,39,.15);
    }
    .spacer{flex:1}
    nav#tabs{
      display:flex;gap:8px;flex-wrap:nowrap; padding:4px; border-radius:999px; background:var(--tab-bg); border:1px solid var(--table-head-line);
      overflow:hidden;
    }
    nav#tabs .inner{ display:flex; gap:8px; overflow:auto; scrollbar-width:none }
    nav#tabs .inner::-webkit-scrollbar{ display:none }
    .tab{
      background:transparent; color:var(--tab-ink); border:0;
      padding:8px 12px; border-radius:999px; font-weight:700; cursor:pointer; white-space:nowrap;
    }
    .tab.active{background:var(--surface); color:var(--text); box-shadow: var(--shadow)}
    .tab:hover{opacity:.95}

    /* Menu button + popover for compact */
    #menuWrap{ display:none; position:relative }
    #menuBtn{
      background: linear-gradient(180deg,var(--surface), var(--muted));
      color: var(--text);
      border:1px solid var(--line); border-radius:12px; padding:8px 10px; cursor:pointer; font-weight:700;
      box-shadow: var(--shadow); display:flex; align-items:center; gap:8px;
    }
    #menuBtn:focus{ outline:none; box-shadow: var(--ring) }
    #menuPopover{
      position:absolute; top:calc(100% + 8px); right:0; min-width:220px;
      background: var(--popover); border:1px solid var(--line); border-radius:16px; box-shadow: var(--shadow);
      padding:6px; display:none; z-index:50;
    }
    #menuPopover.open{ display:block }
    .menu-item{
      width:100%; text-align:left; background:transparent; border:0; padding:10px 12px; border-radius:10px; cursor:pointer; color:var(--text);
      display:flex; align-items:center; gap:8px; font-weight:700;
    }
    .menu-item:hover, .menu-item[aria-current="true"]{ background:var(--tab-bg); border:1px solid var(--table-head-line) }
    .menu-divider{ height:1px; background:var(--line); margin:4px 0 }

    /* Theme button */
    #themeBtn{
      background: linear-gradient(180deg,var(--surface), var(--muted));
      color: var(--text);
      border:1px solid var(--line); border-radius:999px; padding:8px 10px; cursor:pointer; font-weight:700;
      box-shadow: var(--shadow);
    }
    #themeBtn:focus{ outline:none; box-shadow: var(--ring) }

    main{padding:22px; max-width:1200px; margin: 0 auto}
    .toolbar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:16px;
      background: var(--surface); border:1px solid var(--line); border-radius: var(--radius); padding: 10px;
      box-shadow: var(--shadow);
    }
    .btn{
      background: linear-gradient(180deg,var(--surface), var(--muted));
      color:var(--text); border:1px solid var(--line);
      padding:10px 12px; border-radius:12px; font-weight:700; cursor:pointer;
      box-shadow: var(--shadow);
    }
    .btn.primary{
      background: linear-gradient(180deg,var(--brand), var(--brand-ink));
      color:#fff; border:1px solid color-mix(in srgb, var(--brand-ink) 90%, black);
    }
    .btn.ghost{ background:var(--surface); color:var(--text); border:1px dashed var(--line) }
    .btn.small{ padding:8px 10px; border-radius:10px; font-weight:600 }
    .btn:focus{ outline:none; box-shadow: var(--ring) }
    .btn:active{ transform: translateY(1px) }

    section{display:none}
    section.active{display:block; animation:fade .18s ease-out}
    @keyframes fade{from{opacity:.5; transform:translateY(6px)} to{opacity:1; transform:none}}

    .card{
      background: var(--surface);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
    }
    .grid{ display:grid; gap:12px }
    .grid.cols-3{ grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); }
    .row{ display:grid; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); gap:10px }

    form{ background: var(--surface); border:1px solid var(--line); border-radius: var(--radius); padding: 12px; display:grid; gap:12px }
    label{ font-size:12px; color: var(--subtle); font-weight:700; letter-spacing:.25px }
    input, select, textarea{
      width:100%; padding:12px 12px; border-radius:12px;
      background:var(--surface-soft); color:var(--text);
      border: 1px solid var(--line); outline:none;
      transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }
    input:hover, select:hover, textarea:hover{ background:var(--surface) }
    input:focus, select:focus, textarea:focus{
      border-color: var(--brand); box-shadow: var(--ring); background:var(--surface);
    }

    table{ width:100%; border-collapse: separate; border-spacing:0; margin-top:10px; background:var(--surface); border:1px solid var(--line); border-radius:var(--radius); overflow:hidden; box-shadow: var(--shadow) }
    th, td{ padding:12px; border-bottom:1px solid #26304233; text-align:left; font-size:14px }
    thead th{ background:var(--table-head); border-bottom:1px solid var(--table-head-line); position:sticky; top:0; z-index:1 }
    tbody tr:hover{ background: color-mix(in srgb, var(--surface) 92%, var(--brand) 8%) }
    .pill{ background:var(--tab-bg); border:1px solid var(--table-head-line); padding:4px 8px; border-radius:999px; font-size:12px; color:var(--tab-ink) }

    .note{ color: var(--subtle); font-size:12px }

    .flex{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .right{ margin-left:auto }

    .kpi .value{ font-size:30px; font-weight:800 }
    .kpi .label{ color: var(--subtle); font-size:12px }

    .equip-panel{ border:1px solid var(--line); border-radius: var(--radius); overflow:hidden; background: var(--surface); box-shadow: var(--shadow); }
    .equip-header{ padding:16px; background: var(--muted); border-bottom:1px solid var(--line); display:grid; gap:10px; }
    .equip-body{ padding:16px; display:grid; gap:12px }
    .inline-controls{ display:grid; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); gap:10px }
    .schedule-builder{ margin-top:4px; padding:12px; background:var(--surface-soft); border:1px solid var(--line); border-radius: var(--radius-sm); }
    .days{ display:flex; gap:6px; flex-wrap:wrap; margin-top:6px }
    .chip{ display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px; background:var(--muted); border:1px solid var(--line); cursor:pointer; user-select:none; color:var(--text) }
    .chip input{ margin:0 }

    .hidden{ display:none }
    .month-grid{ display:grid; grid-template-columns: repeat(7, minmax(38px, 1fr)); gap:8px; margin-top:8px }
    .day-cell{ display:flex; align-items:center; justify-content:center; height:38px; border:1px solid var(--line); border-radius:12px; background:var(--surface); cursor:pointer; user-select:none; font-weight:700; color:var(--text); transition: box-shadow .12s ease, border-color .12s ease, background .12s ease; }
    .day-cell:hover{ border-color: color-mix(in srgb, var(--brand) 45%, var(--line) 55%); background:var(--surface-soft) }
    .day-cell.selected{ border-color:var(--brand); box-shadow: var(--ring); background:var(--tab-bg) }
    .calendar-note{ font-size:12px; color:var(--subtle); margin-top:6px }
    .calendar-warning{ font-size:12px; color:#b45309; background:#fef3c7; border:1px solid #fde68a; padding:8px; border-radius:12px; margin-top:8px }

    .combo{ position:relative }
    .combo input{ width:100% }
    .combo-list{
      position:absolute; left:0; right:0; top:calc(100% + 6px);
      background:var(--surface); border:1px solid var(--line); border-radius:12px; box-shadow: var(--shadow);
      max-height:240px; overflow:auto; padding:6px;
      z-index:50;
    }
    .combo-item{
      padding:10px 12px; border-radius:10px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; color:var(--text);
    }
    .combo-item:hover, .combo-item.active{ background:var(--tab-bg); border:1px solid var(--table-head-line) }
    .combo-empty{ padding:10px 12px; color:var(--subtle); font-size:12px }
    .combo-hint{ color:var(--subtle); font-size:12px }

    body.nav-compact nav#tabs{ display:none }
    body.nav-compact #menuWrap{ display:block }
    @media (max-width: 720px){
      nav#tabs{ display:none }
      #menuWrap{ display:block }
    }
  
    .brand-logo{ height:44px; width:auto; display:block; object-fit:contain; vertical-align:middle }
  
    /* Toast notifications (non-destructive add) */
    #toast{position:fixed;top:16px;right:16px;z-index:9999;display:flex;flex-direction:column;gap:8px;max-width:420px}
    .toast-item{border:1px solid var(--line);background:var(--surface);color:var(--text);box-shadow:var(--shadow);border-radius:14px;padding:10px 12px;display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}
    .toast-item.success{border-color:color-mix(in srgb,var(--accent) 40%, var(--line) 60%)}
    .toast-item.error{border-color:color-mix(in srgb,#ef4444 50%, var(--line) 50%)}
    .toast-item.warn{border-color:color-mix(in srgb,#f59e0b 50%, var(--line) 50%)}
    .toast-icon{font-size:18px;line-height:1}
    .toast-title{font-weight:800}
    .toast-desc{font-size:13px;color:var(--subtle)}
    .toast-close{background:transparent;border:0;color:var(--subtle);font-weight:800;cursor:pointer}

  
    /* Table placeholders */
    tr.placeholder td{color:var(--subtle);}
    tr.placeholder td .ph{
      display:block; width:100%; height:14px; border:1px dashed var(--line);
      border-radius:8px; background:color-mix(in srgb, var(--surface) 70%, var(--muted) 30%);
    }

  
    /* Placeholder visual polish for a flush, modern look */
    tr.placeholder td{ padding-top:10px; padding-bottom:10px; }
    tr.placeholder td .ph{ height:12px; border-radius:10px; opacity:0.75 }

  
    /* Feedback UI (modal + buttons) */
    .btn{border:1px solid var(--line); background:var(--surface); color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer}
    .btn.primary{border-color:var(--accent);}
    .btn.subtle{opacity:0.8}
    .modal{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:10000}
    .modal.hidden{display:none}
    .modal-card{background:var(--surface); color:var(--text); border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow); width:min(720px, 92vw);}
    .modal-head{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--line)}
    .modal-card form{padding:14px 16px}
    .modal-card .grid.two{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .modal-card label{display:block; font-weight:700; font-size:12px; margin-bottom:6px; color:var(--subtle)}
    .modal-card input,.modal-card select,.modal-card textarea{width:100%; border:1px solid var(--line); background:var(--surface); color:var(--text); border-radius:10px; padding:10px 12px}
    .modal-card .chk{display:flex; align-items:center; gap:8px; font-weight:600}
    .modal-actions{display:flex; gap:10px; justify-content:flex-end; margin-top:10px}
    .modal-close{border:0; background:transparent; cursor:pointer; font-size:18px; color:var(--subtle)}
    .feedback-fab{position:fixed; bottom:18px; right:18px; z-index:9999; border-radius:999px; padding:10px 14px}
    .nav-feedback{margin-left:10px}
    @media (max-width:740px){ .modal-card .grid.two{grid-template-columns:1fr} }

  
    /* Feedback FAB & Modal (always visible) */
    .feedback-fab{position:fixed; bottom:18px; right:18px; z-index:10050; border-radius:999px; padding:12px 16px; box-shadow:var(--shadow)}
    .btn{border:1px solid var(--line); background:var(--surface); color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer}
    .btn.primary{border-color:var(--accent);}
    .modal{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:10040}
    .modal.hidden{display:none}
    .modal-card{background:var(--surface); color:var(--text); border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow); width:min(720px, 92vw);}
    .modal-head{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--line)}
    .modal-card form{padding:14px 16px}
    .modal-card .grid.two{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .modal-card label{display:block; font-weight:700; font-size:12px; margin-bottom:6px; color:var(--subtle)}
    .modal-card input,.modal-card select,.modal-card textarea{width:100%; border:1px solid var(--line); background:var(--surface); color:var(--text); border-radius:10px; padding:10px 12px}
    .modal-card .chk{display:flex; align-items:center; gap:8px; font-weight:600}
    .modal-actions{display:flex; gap:10px; justify-content:flex-end; margin-top:10px}
    .modal-close{border:0; background:transparent; cursor:pointer; font-size:18px; color:var(--subtle)}
    @media (max-width:740px){ .modal-card .grid.two{grid-template-columns:1fr} }

  </style>

  <script>
  (function(){
    try {
      if (location.protocol === 'file:' && 'serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations && navigator.serviceWorker.getRegistrations().then(function(regs){
          regs.forEach(function(r){ r.unregister(); });
        });
      }
    } catch(e) { /* ignore */ }
  })();
  </script>


</head>
<body>

  <script>(function(){function unhide(){document.body.style.opacity='1';}document.addEventListener('DOMContentLoaded',function(){setTimeout(unhide,200);});})();</script>

  <div id="toast" aria-live="polite" aria-atomic="true"></div>
  <header>
    <div class="brand">
      <img src="data:image/png;base64,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" alt="Lhyst logo" class="brand-logo" />
      <h1>Lhyst</h1>
    </div>
    <div class="spacer"></div>
    <nav id="tabs" aria-label="Primary">
      <div class="inner" id="tabsInner"></div>
    </nav>
    <div id="menuWrap">
      <button id="menuBtn" aria-haspopup="true" aria-expanded="false" aria-controls="menuPopover">☰ Menu</button>
      <div id="menuPopover" role="menu" aria-labelledby="menuBtn"></div>
    </div>
    <button id="themeBtn" aria-label="Toggle dark mode">🌙</button>
  </header>

  <main>
    <div class="toolbar">
      <input type="date" id="filterFrom" />
      <input type="date" id="filterTo" />
      <select id="filterType">
        <option value="">All categories</option>
        <option value="temperatures">Temperatures</option>
        <option value="cleaning">Cleaning</option>
        <option value="audits">Audits</option>
      </select>
      <button class="btn primary" id="applyFilter">Filter</button>
      <button class="btn" id="notifyBtn">Enable Notifications</button>
      <button class="btn ghost" id="clearFilter">Clear</button>
      <span class="right"></span>
      <button class="btn" id="backupBtn">Export Backup (JSON)</button>
      <input type="file" id="restoreFile" class="hidden" accept=".json" />
      <button class="btn ghost" id="restoreBtn">Import Backup</button>
    </div>

    <section id="view-dashboard" class="active">
      <div class="grid cols-3">
        <div class="card kpi"><div class="value" id="kpiTemps">0</div><div class="label">Temps logged (7 days)</div></div>
        <div class="card kpi"><div class="value" id="kpiClean">0</div><div class="label">Cleaning tasks (7 days)</div></div>
        <div class="card kpi"><div class="value" id="kpiAudits">0</div><div class="label">Audits (90 days)</div></div>
      </div>
      <div class="card" style="margin-top:12px">
        <h3 style="margin:6px 0 10px 0">Recent Activity</h3>
        <table id="recentTable"><thead><tr>
          <th>When</th><th>Type</th><th>Details</th><th>Staff</th>
        </tr></thead><tbody></tbody></table>
      </div>
    </section>

    <section id="view-temps">
      <form id="tempForm">
        <div class="row">
          <div><label>Food / Location</label><input id="tempItem" required placeholder="e.g., Chicken - Hot Holding"></div>
          <div><label>Temperature (°F)</label><input id="tempValue" type="number" step="0.1" required></div>
          <div><label>Probe / Sensor</label><input id="tempSensor" placeholder="Manual, ThermoPro, etc."></div>
          <div class="combo">
            <label>Staff</label>
            <input id="tempStaff" placeholder="Click or type to search staff" autocomplete="off"/>
            <div class="combo-list hidden" id="tempStaffList"></div>
          </div>
          <div><label>Time</label><input id="tempTime" type="datetime-local"></div>
        </div>
        <div class="row">
          <div><label>Notes</label><input id="tempNotes" placeholder="Optional notes"></div>
          <div><label>Photo</label><input id="tempPhoto" type="file" accept="image/*" capture="environment"></div>
        </div>
        <div class="flex">
          <button class="btn primary" type="submit">Save Temperature</button>
          <button class="btn" type="button" id="bleBtn">Connect BLE Thermometer (optional)</button>
          <span class="right"></span>
          <button class="btn ghost" type="button" id="exportTempsCsv">Export Temps CSV</button>
        </div>
      </form>
      <table id="tempsTable"><thead><tr>
        <th>Time</th><th>Item</th><th>°F</th><th>Sensor</th><th>Staff</th><th>Notes</th><th>Photo</th>
      </tr></thead><tbody></tbody></table>
    </section>

    <section id="view-cleaning">
      <form id="cleanForm">
        <div class="row">
          <div><label>Task</label><input id="cleanTask" required placeholder="e.g., Sanitize cutting boards"></div>
          <div><label>Equipment</label>
            <select id="cleanEquipment"><option value="">None</option></select>
          </div>
          <div class="combo">
            <label>Staff</label>
            <input id="cleanStaff" placeholder="Click or type to search staff" autocomplete="off"/>
            <div class="combo-list hidden" id="cleanStaffList"></div>
          </div>
          <div><label>Time</label><input id="cleanTime" type="datetime-local"></div>
        </div>
        <div class="row">
          <div><label>Notes</label><input id="cleanNotes" placeholder="Optional notes"></div>
          <div><label>Photo</label><input id="cleanPhoto" type="file" accept="image/*" capture="environment"></div>
        </div>
        <div class="flex">
          <button class="btn primary" type="submit">Save Cleaning</button>
          <span class="right"></span>
          <button class="btn ghost" type="button" id="exportCleaningCsv">Export Cleaning CSV</button>
        </div>
      </form>
      <table id="cleanTable"><thead><tr>
        <th>Time</th><th>Task</th><th>Equipment</th><th>Staff</th><th>Notes</th><th>Photo</th>
      </tr></thead><tbody></tbody></table>
    </section>

    <section id="view-audits">
      <form id="auditForm">
        <div class="row">
          <div><label>Audit Type</label><input id="auditType" required placeholder="e.g., Health Inspection"></div>
          <div><label>Result</label><input id="auditResult" placeholder="Pass, Needs follow-up, etc."></div>
          <div class="combo">
            <label>Staff</label>
            <input id="auditStaff" placeholder="Click or type to search staff" autocomplete="off"/>
            <div class="combo-list hidden" id="auditStaffList"></div>
          </div>
          <div><label>Time</label><input id="auditTime" type="datetime-local"></div>
        </div>
        <div class="row">
          <div><label>Notes</label><textarea id="auditNotes" rows="3" placeholder="Findings, corrective actions, etc."></textarea></div>
          <div><label>Attachment</label><input id="auditPhoto" type="file" accept="image/*,.pdf"></div>
        </div>
        <div class="flex">
          <button class="btn primary" type="submit">Save Audit</button>
          <span class="right"></span>
          <button class="btn ghost" type="button" id="exportAuditsCsv">Export Audits CSV</button>
        </div>
      </form>
      <table id="auditTable"><thead><tr>
        <th>Time</th><th>Type</th><th>Result</th><th>Staff</th><th>Notes</th><th>Attachment</th>
      </tr></thead><tbody></tbody></table>
    </section>

    <section id="view-equipment">
      <div class="equip-panel">
        <div class="equip-header">
          <div class="inline-controls">
            <div><label>Name</label><input id="equipName" required placeholder="e.g., Grill #1"></div>
            <div><label>Enable Reminders</label>
              <select id="equipRemindersEnabled">
                <option value="no">No</option>
                <option value="yes">Yes</option>
              </select>
            </div>
          </div>
        </div>
        <div class="equip-body">
          <div class="equip-section">
            <label style="font-weight:800">Alarm Schedule</label>
            <div class="schedule-builder">
              <div class="row">
                <div>
                  <label>Schedule Type</label>
                  <select id="schedType">
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                  </select>
                </div>
                <div id="weeklyPicker">
                  <label>Days of Week</label>
                  <div class="days">
                    <label class="chip"><input type="checkbox" value="0">Sun</label>
                    <label class="chip"><input type="checkbox" value="1">Mon</label>
                    <label class="chip"><input type="checkbox" value="2">Tue</label>
                    <label class="chip"><input type="checkbox" value="3">Wed</label>
                    <label class="chip"><input type="checkbox" value="4">Thu</label>
                    <label class="chip"><input type="checkbox" value="5">Fri</label>
                    <label class="chip"><input type="checkbox" value="6">Sat</label>
                  </div>
                </div>
                <div id="monthlyPicker" class="hidden">
                  <label>Select Days of Month</label>
                  <div class="month-grid" id="monthGrid"></div>
                  <div class="calendar-note">Tip: Select multiple days (e.g., 1, 15, 31).</div>
                  <div class="calendar-warning hidden" id="monthWarning"></div>
                  <div style="margin-top:8px">
                    <label class="chip"><input type="checkbox" id="autoRollToggle"> Use last day of month if a selected day doesn't exist</label>
                  </div>
                </div>
                <div>
                  <label>Time (24h HH:MM)</label>
                  <input id="schedTime" placeholder="09:00" />
                </div>
              </div>
              <div class="flex" style="margin-top:6px">
                <button class="btn small primary" id="addSchedule" type="button">Add to Schedule</button>
                <span class="note">Add multiple weekly and/or monthly alarms.</span>
              </div>
              <div id="scheduleList" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px"></div>
            </div>
          </div>

          <div class="flex" style="margin-top:8px">
            <button class="btn primary" id="addEquipBtn">Add Equipment</button>
            <span class="note">Reminders prompt Cleaning logs; actual timestamps are captured when you save the Cleaning entry.</span>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3 style="margin:6px 0 6px 0">Equipment List</h3>
        <table id="equipTable"><thead><tr>
          <th>Name</th><th>Schedules</th><th>Enabled</th><th>Actions</th>
        </tr></thead><tbody></tbody></table>
      </div>
    </section>

    <section id="view-staff">
      <div class="card">
        <h3 style="margin:6px 0 6px 0">Add Staff</h3>
        <form id="staffForm">
          <div class="row">
            <div><label>Name</label><input id="staffName" required placeholder="e.g., Alex Johnson"></div>
            <div><label>Role (optional)</label><input id="staffRole" placeholder="e.g., Line Cook"></div>
          </div>
          <div class="flex">
            <button class="btn primary" type="submit">Add Staff</button>
          </div>
        </form>
      </div>

      <div class="card" style="margin-top:12px">
        <h3 style="margin:6px 0 6px 0">Staff List</h3>
        <table id="staffTable"><thead><tr>
          <th>Name</th><th>Role</th><th>Actions</th>
        </tr></thead><tbody></tbody></table>
      </div>
    </section>
  </main>

  <script>
  // Tabs
  const TABS = [
    {id:'dashboard', label:'Home'},
    {id:'temps', label:'Temperatures'},
    {id:'cleaning', label:'Cleaning'},
    {id:'audits', label:'Audits'},
    {id:'equipment', label:'Equipment'},
    {id:'staff', label:'Staff'}
  ];
  const tabsInner = document.getElementById('tabsInner');
  function renderTabs(){
    tabsInner.innerHTML='';
    TABS.forEach(t=>{
      const b=document.createElement('button'); b.className='tab'; b.textContent=t.label; b.dataset.view=t.id;
      b.onclick=()=>show(t.id);
      tabsInner.appendChild(b);
    });
  }
  renderTabs();

  function show(id){
    document.querySelectorAll('.tab').forEach(b=>b.classList.toggle('active',b.dataset.view===id));
    document.querySelectorAll('main section').forEach(s=>s.classList.remove('active'));
    document.getElementById('view-'+id).classList.add('active');
    // reflect in menu
    highlightMenu(id);
    history.replaceState(null, '', '#view-'+id);
    closeMenu();
  }

  // Click menu popover
  const menuBtn = document.getElementById('menuBtn');
  const menu = document.getElementById('menuPopover');
  function renderMenu(){
    menu.innerHTML = TABS.map((t,i)=>`<button class="menu-item" role="menuitem" data-view="${t.id}" ${i===0?'tabindex="0"':''}>${t.label}</button>`).join('');
    menu.querySelectorAll('.menu-item').forEach(btn=> btn.addEventListener('click', ()=> show(btn.dataset.view)));
  }
  function openMenu(){
    menu.classList.add('open');
    menuBtn.setAttribute('aria-expanded','true');
    // focus first item
    const first = menu.querySelector('.menu-item'); first && first.focus();
    document.addEventListener('click', onDocClick);
    document.addEventListener('keydown', onMenuKeys);
  }
  function closeMenu(){
    menu.classList.remove('open');
    menuBtn.setAttribute('aria-expanded','false');
    document.removeEventListener('click', onDocClick);
    document.removeEventListener('keydown', onMenuKeys);
  }
  function toggleMenu(){ menu.classList.contains('open') ? closeMenu() : openMenu(); }
  function onDocClick(e){
    if(!menu.contains(e.target) && e.target!==menuBtn){ closeMenu(); }
  }
  function onMenuKeys(e){
    const items = Array.from(menu.querySelectorAll('.menu-item'));
    const idx = items.indexOf(document.activeElement);
    if(e.key==='Escape'){ e.preventDefault(); closeMenu(); menuBtn.focus(); return; }
    if(e.key==='ArrowDown'){ e.preventDefault(); (items[idx+1]||items[0])?.focus(); }
    if(e.key==='ArrowUp'){ e.preventDefault(); (items[idx-1]||items[items.length-1])?.focus(); }
    if(e.key==='Home'){ e.preventDefault(); items[0]?.focus(); }
    if(e.key==='End'){ e.preventDefault(); items[items.length-1]?.focus(); }
    if(e.key==='Enter' || e.key===' '){
      if((document.activeElement && document.activeElement.classList && document.activeElement.classList.contains('menu-item'))){
        e.preventDefault(); document.activeElement.click();
      }
    }
  }
  function highlightMenu(currentId){
    menu.querySelectorAll('.menu-item').forEach(btn=> btn.setAttribute('aria-current', btn.dataset.view===currentId ? 'true' : 'false'));
  }
  menuBtn.addEventListener('click', toggleMenu);
  renderMenu();

  // Auto-condense nav based on available width
  const header = document.querySelector('header');
  const tabsNav = document.getElementById('tabs');
  function checkNavFit(){
    const tooNarrow = header.scrollWidth > header.clientWidth + 2 ||
                      tabsNav.scrollWidth > tabsNav.clientWidth + 2;
    document.body.classList.toggle('nav-compact', tooNarrow);
  }
  new ResizeObserver(checkNavFit).observe(header);
  window.addEventListener('resize', checkNavFit);
  window.addEventListener('load', checkNavFit);

  // Theme toggle
  const themeBtn = document.getElementById('themeBtn');
  function applyTheme(theme){
    if(theme==='auto'){
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
    }else{
      document.documentElement.setAttribute('data-theme', theme);
    }
    themeBtn.textContent = document.documentElement.getAttribute('data-theme')==='dark' ? '☀️' : '🌙';
  }
  function getSavedTheme(){ return localStorage.getItem('fs-theme') || 'auto'; }
  function setSavedTheme(t){ localStorage.setItem('fs-theme', t); }
  function toggleTheme(){
    const current = getSavedTheme();
    const next = current==='light' ? 'dark' : current==='dark' ? 'auto' : 'light'; // cycle
    setSavedTheme(next); applyTheme(next);
  }
  themeBtn.addEventListener('click', toggleTheme);
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', ()=>{ if(getSavedTheme()==='auto') applyTheme('auto'); });
  applyTheme(getSavedTheme());

  // Routing via hash (optional)
  if(location.hash.startsWith('#view-')){
    const id = location.hash.replace('#view-','');
    if(TABS.some(t=>t.id===id)) show(id);
  } else {
    show('dashboard');
  }

  // ====== IndexedDB + helpers (same as previous) ======
  const DB_NAME='fs-logbook-v5';
  const DB_VERSION=5;
  const stores=['temperatures','cleaning','audits','equipment','staff'];
  let db;
  const openDB = () => new Promise((resolve,reject)=>{
    const req=indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = (e)=>{
      const d=e.target.result;
      stores.forEach(s=>{
        if(!d.objectStoreNames.contains(s)){
          const os=d.createObjectStore(s,{keyPath:'id',autoIncrement:true});
          if(s!=='staff') os.createIndex('by_time','time');
          if(s==='staff'){ os.createIndex('by_name','name',{unique:false}); }
        }
      });
    };
    req.onsuccess=()=>{db=req.result; resolve(db)};
    req.onerror=()=>reject(req.error);
  });
  const tx = (store, mode='readonly') => db.transaction(store, mode).objectStore(store);
  const add = (store, value) => new Promise((res,rej)=>{const r=tx(store,'readwrite').add(value); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error)});
  const getAll = (store) => new Promise((res,rej)=>{const r=tx(store).getAll(); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error)});
  const put = (store, value) => new Promise((res,rej)=>{const r=tx(store,'readwrite').put(value); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error)});
  const del = (store, key) => new Promise((res,rej)=>{const r=tx(store,'readwrite').delete(key); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error)});

  const $ = (id)=>document.getElementById(id);
  const toISO = (dt)=> dt ? new Date(dt).toISOString() : new Date().toISOString();
  const blobToDataURL = (blob)=> new Promise((resolve)=>{ const r=new FileReader(); r.onload=()=>resolve(r.result); r.readAsDataURL(blob); });

  // Staff COMBOBOX
  const staffCache = { list: [] };
  async function loadStaff(){
    await openDB();
    staffCache.list = (await getAll('staff')).map(s=>({name:s.name||'', role:s.role||'', id:s.id})).sort((a,b)=>a.name.localeCompare(b.name));
    renderAllCombos();
  }
  function renderCombo(listEl, query){
    const wrap = listEl;
    const q = (query||'').trim().toLowerCase();
    const matches = staffCache.list.filter(s => s.name.toLowerCase().includes(q));
    const icon = '<span class="combo-hint">'+ (q? 'Enter to use typed name' : 'Click a name or type') +'</span>';
    if(!staffCache.list.length){
      wrap.innerHTML = '<div class="combo-empty">No staff yet — add names in the Staff tab.</div>';
      return;
    }
    if(!matches.length){
      wrap.innerHTML = '<div class="combo-empty">No matches. '+icon+'</div>';
      return;
    }
    wrap.innerHTML = matches.map((s,i)=>`<div class="combo-item${i===0?' active':''}" data-name="${s.name.replace(/"/g,'&quot;')}"><span>${s.name}</span><span class="combo-hint">${s.role||''}</span></div>`).join('');
    wrap.querySelectorAll('.combo-item').forEach(el=>{
      el.addEventListener('mousedown', (e)=>{
        e.preventDefault();
        const name = el.getAttribute('data-name');
        const inputId = wrap.getAttribute('data-for');
        const input = document.getElementById(inputId);
        input.value = name;
        hideCombo(wrap);
        input.dispatchEvent(new Event('change'));
      });
    });
  }
  function showCombo(listEl){ listEl.classList.remove('hidden'); }
  function hideCombo(listEl){ listEl.classList.add('hidden'); }
  function wireCombo(inputEl, listEl){
    listEl.setAttribute('data-for', inputEl.id);
    inputEl.addEventListener('focus', ()=>{ renderCombo(listEl, inputEl.value); showCombo(listEl); });
    inputEl.addEventListener('click', ()=>{ renderCombo(listEl, inputEl.value); showCombo(listEl); });
    inputEl.addEventListener('input', ()=>{ renderCombo(listEl, inputEl.value); showCombo(listEl); });
    inputEl.addEventListener('keydown', (e)=>{
      const items = Array.from(listEl.querySelectorAll('.combo-item'));
      const active = listEl.querySelector('.combo-item.active');
      const idx = items.indexOf(active);
      if(e.key==='ArrowDown'){ e.preventDefault(); const next = items[Math.min(idx+1, items.length-1)] || items[0]; items.forEach(i=>i.classList.remove('active')); if(next){ next.classList.add('active'); }; }
      if(e.key==='ArrowUp'){ e.preventDefault(); const prev = items[Math.max(idx-1, 0)] || items[items.length-1]; items.forEach(i=>i.classList.remove('active')); if(prev){ prev.classList.add('active'); }; }
      if(e.key==='Enter'){
        if(active){ e.preventDefault(); active.dispatchEvent(new Event('mousedown')); }
      }
      if(e.key==='Escape'){ hideCombo(listEl); }
    });
    inputEl.addEventListener('blur', ()=> setTimeout(()=> hideCombo(listEl), 120));
  }
  function renderAllCombos(){
    const combos = [
      {input:$('tempStaff'), list:$('tempStaffList')},
      {input:$('cleanStaff'), list:$('cleanStaffList')},
      {input:$('auditStaff'), list:$('auditStaffList')},
    ];
    combos.forEach(c=>{ if(c.input && c.list){ renderCombo(c.list, c.input.value); } });
  }

  // Filters
  let filter = {from:null,to:null,type:''};
  $('applyFilter').onclick=()=>{
    filter.from=$('filterFrom').value? new Date($('filterFrom').value).toISOString():null;
    filter.to=$('filterTo').value? new Date($('filterTo').value).toISOString():null;
    filter.type=$('filterType').value || '';
    refreshAll();
  };
  $('clearFilter').onclick=()=>{
    $('filterFrom').value=''; $('filterTo').value=''; $('filterType').value='';
    filter={from:null,to:null,type:''}; refreshAll();
  };

  // Notifications
  $('notifyBtn').onclick=async()=>{
    try{
      if(!('Notification' in window)) return alert('Notifications not supported in this browser.');
      const perm = await Notification.requestPermission();
      if(perm!=='granted') alert('Notifications permission was not granted.');
      else alert('Notifications enabled.');
    }catch(e){ console.warn(e); alert('Could not request notifications.'); }
  };

  // Backup / Restore
  $('backupBtn').onclick=async()=>{
    await openDB();
    const [temps,cleaning,audits,equipment,staff] = await Promise.all([getAll('temperatures'), getAll('cleaning'), getAll('audits'), getAll('equipment'), getAll('staff')]);
    const conv = async (arr)=>Promise.all(arr.map(async item=>{
      const it={...item};
      for(const k of ['photo','attachment']){ if(it[k] instanceof Blob){ it[k] = await blobToDataURL(it[k]); } }
      return it;
    }));
    const payload = {
      exportedAt: new Date().toISOString(),
      temperatures: await conv(temps),
      cleaning: await conv(cleaning),
      audits: await conv(audits),
      equipment,
      staff
    };
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
    a.download='fs-logbook-backup.json'; a.click();
  };
  $('restoreBtn').onclick=()=>$('restoreFile').click();
  $('restoreFile').onchange=async(e)=>{
    const file=e.target.files[0]; if(!file) return;
    const text=await file.text(); const data=JSON.parse(text);
    await openDB();
    for(const s of ['temperatures','cleaning','audits','equipment','staff']){
      const arr = data[s] || [];
      for(const item of arr){
        for(const k of ['photo','attachment']){
          if(item[k] && typeof item[k]==='string' && item[k].startsWith('data:')){
            const res = await fetch(item[k]); const b = await res.blob(); item[k]=b;
          }
        }
        delete item.id; await add(s, item);
      }
    }
    alert('Backup imported.'); refreshAll();
  };

  // BLE (optional)
  document.getElementById('bleBtn')?.addEventListener('click', async ()=>{
    try{
      const device = await navigator.bluetooth.requestDevice({ filters:[{services:['health_thermometer']}], optionalServices:['device_information'] });
      const server = await device.gatt.connect();
      const service = await server.getPrimaryService('health_thermometer');
      try{
        const ch = await service.getCharacteristic('temperature_measurement');
        await ch.startNotifications();
        ch.oncharacteristicvaluechanged = (ev)=>{
          const dv = ev.target.value;
          let tempF = null;
          if(dv.byteLength>=5){
            const v = new DataView(dv.buffer);
            const celsius = v.getFloat32(1,true);
            tempF = (celsius*9/5)+32;
          }
          if(tempF){ $('tempValue').value = tempF.toFixed(1); $('tempSensor').value = device.name || 'BLE Thermometer'; }
        };
        alert('Connected. Take a measurement to auto-fill.');
      }catch(e){
        alert('Connected, but could not subscribe to measurements. Enter manually.');
      }
    }catch(err){
      console.warn('BLE error', err); alert('Could not connect to a BLE thermometer (optional).');
    }
  });

  // Submit handlers
  $('tempForm').onsubmit=async(e)=>{
    e.preventDefault(); await openDB();
    const file=$('tempPhoto').files[0];
    const staff = $('tempStaff').value.trim();
    const rec={
      time: toISO($('tempTime').value||Date.now()),
      item: $('tempItem').value.trim(),
      valueF: parseFloat($('tempValue').value),
      sensor: $('tempSensor').value.trim()||'Manual',
      staff,
      notes: $('tempNotes').value.trim(),
      photo: file || null,
      type:'temperatures'
    };
    await add('temperatures', rec); e.target.reset(); refreshTemps(); refreshDashboard();
  };

  $('cleanForm').onsubmit=async(e)=>{
    e.preventDefault(); await openDB();
    const file=$('cleanPhoto').files[0];
    const equipSel=$('cleanEquipment'); const equipId = equipSel.value ? parseInt(equipSel.value) : null;
    const equipName = equipSel.selectedOptions[0]?.text || '';
    const staff = $('cleanStaff').value.trim();
    const rec={
      time: toISO($('cleanTime').value||Date.now()),
      task: $('cleanTask').value.trim(),
      equipmentId: equipId, equipmentName: equipName,
      staff,
      notes: $('cleanNotes').value.trim(),
      photo: file || null,
      type:'cleaning'
    };
    await add('cleaning', rec); e.target.reset(); refreshCleaning(); refreshDashboard();
  };

  $('auditForm').onsubmit=async(e)=>{
    e.preventDefault(); await openDB();
    const file=$('auditPhoto').files[0];
    const staff = $('auditStaff').value.trim();
    const rec={
      time: toISO($('auditTime').value||Date.now()),
      auditType: $('auditType').value.trim(),
      result: $('auditResult').value.trim(),
      staff,
      notes: $('auditNotes').value.trim(),
      attachment: file || null,
      type:'audits'
    };
    await add('audits', rec); e.target.reset(); refreshAudits(); refreshDashboard();
  };

  // Equipment scheduling + monthly auto-roll
  const scheduleDraft=[];
  const schedType=$('schedType'); const weeklyPicker=$('weeklyPicker'); const monthlyPicker=$('monthlyPicker'); const schedTime=$('schedTime');
  const monthGrid=document.getElementById('monthGrid'); const monthWarning=document.getElementById('monthWarning'); const autoRollToggle=document.getElementById('autoRollToggle');

  function buildMonthGrid(){
    if(!monthGrid) return;
    monthGrid.innerHTML='';
    for(let d=1; d<=31; d++){
      const cell=document.createElement('div');
      cell.className='day-cell';
      cell.textContent=String(d);
      cell.dataset.day=d;
      cell.onclick=()=>{ cell.classList.toggle('selected'); renderMonthWarning(); };
      monthGrid.appendChild(cell);
    }
  }
  function getSelectedMonthDays(){
    return Array.from(monthGrid?.querySelectorAll('.day-cell.selected')||[]).map(c=>parseInt(c.dataset.day,10)).sort((a,b)=>a-b);
  }
  function renderMonthWarning(){
    if(!monthWarning) return;
    const days=getSelectedMonthDays();
    const risky=days.filter(d=>d>=29);
    if(risky.length && !autoRollToggle.checked){
      monthWarning.classList.remove('hidden');
      monthWarning.textContent = `Heads-up: ${risky.join(', ')} may not occur every month. Turn on "Use last day of month" to auto-roll.`;
    }else{
      monthWarning.classList.add('hidden');
      monthWarning.textContent='';
    }
  }

  schedType.onchange=()=>{
    const isMonthly = schedType.value==='monthly';
    weeklyPicker.classList.toggle('hidden', isMonthly);
    monthlyPicker.classList.toggle('hidden', !isMonthly);
    renderMonthWarning();
  };

  buildMonthGrid();
  schedType.onchange();
  autoRollToggle.addEventListener('change', renderMonthWarning);

  function renderScheduleList(el, list){
    if(!el) return;
    if(!list.length){ el.innerHTML='<span class="note">No schedules added yet.</span>'; return; }
    const days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    el.innerHTML = list.map((s)=>{
      if(s.type==='weekly'){
        return `<span class="pill">Weekly: ${s.daysOfWeek.map(d=>days[d]).join('/')} @ ${s.time}</span>`;
      }else{
        const doms = (s.daysOfMonth||[s.dayOfMonth]).join(',');
        const ar = s.autoRollLastDay ? ' (auto-roll)' : '';
        return `<span class="pill">Monthly: days ${doms} @ ${s.time}${ar}</span>`;
      }
    }).join('');
  }

  document.getElementById('addSchedule').onclick=()=>{
    const time = (schedTime.value||'').trim();
    if(!/^\d{1,2}:\d{2}$/.test(time)){ alert('Enter time as HH:MM (24h).'); return; }
    if(schedType.value==='weekly'){
      const checks = weeklyPicker.querySelectorAll('input[type="checkbox"]:checked');
      const days = Array.from(checks).map(c=>parseInt(c.value,10));
      if(!days.length){ alert('Pick at least one weekday.'); return; }
      scheduleDraft.push({type:'weekly', daysOfWeek: days, time});
    }else{
      const days = getSelectedMonthDays();
      if(!days.length){ alert('Select at least one day of the month.'); return; }
      scheduleDraft.push({type:'monthly', daysOfMonth: days, time, autoRollLastDay: !!autoRollToggle.checked});
      monthGrid.querySelectorAll('.day-cell.selected').forEach(c=>c.classList.remove('selected'));
      autoRollToggle.checked=false;
      renderMonthWarning();
    }
    renderScheduleList(document.getElementById('scheduleList'), scheduleDraft);
  };

  document.getElementById('addEquipBtn').onclick=async(e)=>{
    e.preventDefault(); await openDB();
    const name=$('equipName').value.trim();
    const enabled = $('equipRemindersEnabled').value==='yes';
    const schedules = enabled ? scheduleDraft.slice() : [];
    if(!name){ alert('Enter equipment name.'); return; }
    await add('equipment', {time:new Date().toISOString(), name, reminderEnabled: enabled, schedules, firedKeys:{}, monthWarned:{} });
    scheduleDraft.length=0; renderScheduleList(document.getElementById('scheduleList'), scheduleDraft);
    $('equipName').value=''; $('equipRemindersEnabled').value='no'; $('schedType').value='weekly'; schedType.onchange(); $('schedTime').value='';
    document.querySelectorAll('#weeklyPicker input[type="checkbox"]').forEach(c=>c.checked=false);
    refreshEquipment();
  };

  async function refreshEquipment(){
    await openDB(); const equipment = await getAll('equipment');
    const sel=$('cleanEquipment'); if(sel){ sel.innerHTML='<option value="">None</option>'; }
    equipment.forEach(eq=>{
      const opt=document.createElement('option'); opt.value=eq.id; opt.textContent=eq.name; sel?.appendChild(opt);
    });
    const tb=document.querySelector('#equipTable tbody'); if(tb) tb.innerHTML='';
    const days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    equipment.forEach(eq=>{
      const scheds=(eq.schedules||[]).map(s=> s.type==='weekly'
        ? `Weekly ${s.daysOfWeek.map(d=>days[d]).join('/')} @ ${s.time}`
        : `Monthly days ${(s.daysOfMonth||[s.dayOfMonth]).join(', ')} @ ${s.time}${s.autoRollLastDay?' (auto-roll)':''}`).join('<br>');
      const enabled=eq.reminderEnabled?'Yes':'No';
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${eq.name}</td><td>${scheds||'-'}</td><td>${enabled}</td>
        <td class="flex">
          <button class="btn small" data-edit="${eq.id}">Edit</button>
          <button class="btn small" data-toggle="${eq.id}">${eq.reminderEnabled?'Disable':'Enable'}</button>
          <button class="btn small" data-del="${eq.id}">Delete</button>
        </td>`;
      tb?.appendChild(tr);
    });
    tb?.querySelectorAll('button[data-del]').forEach(b=>b.onclick=async()=>{ await del('equipment', parseInt(b.dataset.del)); refreshEquipment(); });
    tb?.querySelectorAll('button[data-toggle]').forEach(b=>b.onclick=async()=>{
      const id=parseInt(b.dataset.toggle);
      const equipmentAll=await getAll('equipment'); const item=equipmentAll.find(x=>x.id===id); if(!item) return;
      item.reminderEnabled = !item.reminderEnabled; await put('equipment', item); refreshEquipment();
    });
    tb?.querySelectorAll('button[data-edit]').forEach(b=>b.onclick=async()=>{
      const id=parseInt(b.dataset.edit);
      const equipmentAll=await getAll('equipment'); const item=equipmentAll.find(x=>x.id===id); if(!item) return;
      const current = (item.schedules||[]).map(s=> s.type==='weekly'
        ?`weekly ${s.daysOfWeek.map(d=>['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d]).join(',')} ${s.time}`
        :`monthly ${(s.daysOfMonth||[s.dayOfMonth]).join(',')} ${s.time}${s.autoRollLastDay?' autoroll':''}`).join('\n');
      const action = prompt('Edit schedules (one per line). Add "autoroll" to auto-roll the last day.\nExamples:\nweekly Mon,Wed 09:00\nmonthly 1,15,31 10:30 autoroll\n(Current will be replaced)', current);
      if(action===null) return;
      const lines = action.split(/\n+/).map(s=>s.trim()).filter(Boolean);
      const parseDay=(name)=>['sun','mon','tue','wed','thu','fri','sat'].indexOf(name.toLowerCase().slice(0,3));
      const parsed=[];
      for(const line of lines){
        const mWeekly = line.match(/^weekly\s+([A-Za-z,\s]+)\s+(\d{1,2}:\d{2})$/i);
        const mMonthly = line.match(/^monthly\s+([0-9,\s]+)\s+(\d{1,2}:\d{2})(\s+autoroll)?$/i);
        if(mWeekly){
          const days = mWeekly[1].split(',').map(s=>parseDay(s.trim())).filter(d=>d>=0);
          const time=mWeekly[2];
          if(!days.length){ alert('Invalid weekly days in: '+line); return; }
          parsed.push({type:'weekly', daysOfWeek:days, time});
        }else if(mMonthly){
          const doms = mMonthly[1].split(',').map(s=>parseInt(s.trim(),10)).filter(n=>n>=1&&n<=31);
          const time=mMonthly[2];
          const ar=!!mMonthly[3];
          if(!doms.length){ alert('Invalid monthly days in: '+line); return; }
          parsed.push({type:'monthly', daysOfMonth:doms, time, autoRollLastDay: ar});
        }else{
          alert('Could not parse: '+line); return;
        }
      }
      item.schedules = parsed; await put('equipment', item); refreshEquipment();
    });
  }

  // Renderers + dashboard
  function inFilter(rec){
    if(filter.type && rec.type!==filter.type) return false;
    if(filter.from && rec.time < filter.from) return false;
    if(filter.to && rec.time > new Date(new Date(filter.to).getTime()+24*3600*1000).toISOString()) return false;
    return true;
  }
  async function refreshTemps(){
    await openDB(); const rows=(await getAll('temperatures')).filter(inFilter).sort((a,b)=>b.time.localeCompare(a.time));
    const tb=document.querySelector('#tempsTable tbody'); if(tb) tb.innerHTML='';
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      const photoCell = r.photo ? '<span class="pill">View</span>' : '';
      tr.innerHTML = `<td>${new Date(r.time).toLocaleString()}</td><td>${r.item}</td><td>${(r.valueF && r.valueF.toFixed ? r.valueF.toFixed(1) : '')}</td>
        <td>${r.sensor||''}</td><td>${r.staff||''}</td><td>${r.notes||''}</td><td>${photoCell}</td>`;
      if(r.photo){
        tr.querySelector('td:last-child').onclick=()=>{ const url=URL.createObjectURL(r.photo); window.open(url,'_blank'); };
      }
      tb?.appendChild(tr);
    });
    document.getElementById('exportTempsCsv').onclick=()=>{
      const toCSV=(arr,headers)=>[headers.join(','), ...arr.map(row=>headers.map(h=>`"${(''+(row[h]??'')).replaceAll('"','""')}"`).join(','))].join('\n');
      const download=(name,csv)=>{ const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); };
      download('temperatures.csv', toCSV(rows.map(r=>({time:r.time,item:r.item,valueF:r.valueF,sensor:r.sensor,staff:r.staff,notes:r.notes})), ['time','item','valueF','sensor','staff','notes']));
    };
  }
  async function refreshCleaning(){
    await openDB(); const rows=(await getAll('cleaning')).filter(inFilter).sort((a,b)=>b.time.localeCompare(a.time));
    const tb=document.querySelector('#cleanTable tbody'); if(tb) tb.innerHTML='';
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      const photoCell = r.photo ? '<span class="pill">View</span>' : '';
      tr.innerHTML = `<td>${new Date(r.time).toLocaleString()}</td><td>${r.task}</td><td>${r.equipmentName||''}</td>
        <td>${r.staff||''}</td><td>${r.notes||''}</td><td>${photoCell}</td>`;
      if(r.photo){
        tr.querySelector('td:last-child').onclick=()=>{ const url=URL.createObjectURL(r.photo); window.open(url,'_blank'); };
      }
      tb?.appendChild(tr);
    });
    document.getElementById('exportCleaningCsv').onclick=()=>{
      const toCSV=(arr,headers)=>[headers.join(','), ...arr.map(row=>headers.map(h=>`"${(''+(row[h]??'')).replaceAll('"','""')}"`).join(','))].join('\n');
      const download=(name,csv)=>{ const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); };
      download('cleaning.csv', toCSV(rows.map(r=>({time:r.time,task:r.task,equipment:r.equipmentName,staff:r.staff,notes:r.notes})), ['time','task','equipment','staff','notes']));
    };
  }
  async function refreshAudits(){
    await openDB(); const rows=(await getAll('audits')).filter(inFilter).sort((a,b)=>b.time.localeCompare(a.time));
    const tb=document.querySelector('#auditTable tbody'); if(tb) tb.innerHTML='';
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      const attCell = r.attachment ? '<span class="pill">Open</span>' : '';
      tr.innerHTML = `<td>${new Date(r.time).toLocaleString()}</td><td>${r.auditType}</td><td>${r.result||''}</td>
        <td>${r.staff||''}</td><td>${r.notes||''}</td><td>${attCell}</td>`;
      if(r.attachment){
        tr.querySelector('td:last-child').onclick=()=>{ const url=URL.createObjectURL(r.attachment); window.open(url,'_blank'); };
      }
      tb?.appendChild(tr);
    });
    document.getElementById('exportAuditsCsv').onclick=()=>{
      const toCSV=(arr,headers)=>[headers.join(','), ...arr.map(row=>headers.map(h=>`"${(''+(row[h]??'')).replaceAll('"','""')}"`).join(','))].join('\n');
      const download=(name,csv)=>{ const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); };
      download('audits.csv', toCSV(rows.map(r=>({time:r.time,auditType:r.auditType,result:r.result,staff:r.staff,notes:r.notes})), ['time','auditType','result','staff','notes']));
    };
  }
  async function refreshStaff(){
    await openDB();
    const list = (await getAll('staff')).sort((a,b)=> (a.name||'').localeCompare(b.name||''));
    const tb=document.querySelector('#staffTable tbody'); if(tb) tb.innerHTML='';
    list.forEach(s=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${s.name||''}</td><td>${s.role||''}</td>
        <td class="flex">
          <button class="btn small" data-edit="${s.id}">Edit</button>
          <button class="btn small" data-del="${s.id}">Delete</button>
        </td>`;
      tb?.appendChild(tr);
    });
    tb?.querySelectorAll('button[data-del]').forEach(b=>b.onclick=async()=>{ await del('staff', parseInt(b.dataset.del)); await refreshStaff(); await loadStaff(); });
    tb?.querySelectorAll('button[data-edit]').forEach(b=>b.onclick=async()=>{
      const id=parseInt(b.dataset.edit,10);
      const all=await getAll('staff'); const item=all.find(x=>x.id===id); if(!item) return;
      const name=prompt('Edit staff name:', item.name||''); if(name===null) return;
      const role=prompt('Edit role (optional):', item.role||''); if(role===null) return;
      item.name = name.trim(); item.role = role.trim();
      await put('staff', item); await refreshStaff(); await loadStaff();
    });
  }

  async function refreshDashboard(){
    await openDB();
    const [t,c,a] = await Promise.all([getAll('temperatures'), getAll('cleaning'), getAll('audits')]);
    const k = (arr, days)=>arr.filter(x=>Date.now()-new Date(x.time).getTime()<days*864e5).length;
    document.getElementById('kpiTemps').textContent = k(t,7);
    document.getElementById('kpiClean').textContent = k(c,7);
    document.getElementById('kpiAudits').textContent = k(a,90);
    const all=[...t,...c,...a].sort((x,y)=>y.time.localeCompare(x.time)).slice(0,10);
    const tb=document.querySelector('#recentTable tbody'); if(tb) tb.innerHTML='';
    all.forEach(r=>{
      const details = r.type==='temperatures' ? `${r.item} – ${r.valueF?.toFixed?.(1)}°F`
        : r.type==='cleaning' ? `${r.task} – ${r.equipmentName||''}`
        : `${r.auditType} – ${r.result||''}`;
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${new Date(r.time).toLocaleString()}</td><td>${r.type}</td><td>${details}</td><td>${r.staff||''}</td>`;
      tb?.appendChild(tr);
    });
  }

  async function refreshAll(){ await Promise.all([refreshTemps(), refreshCleaning(), refreshAudits(), refreshEquipment(), refreshStaff(), refreshDashboard()]); }

  // Reminders & monthly auto-roll
  function hhmm(d){ return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false}); }
  function ymd(d){ const y=d.getFullYear(), m=(d.getMonth()+1).toString().padStart(2,'0'), day=d.getDate().toString().padStart(2,'0'); return `${y}-${m}-${day}`; }
  function ym(d){ const y=d.getFullYear(), m=(d.getMonth()+1).toString().padStart(2,'0'); return `${y}-${m}`; }
  function dow(d){ return d.getDay(); }
  function daysInMonth(y,m){ return new Date(y, m, 0).getDate(); }

  function gotoCleaningWithEquip(equipId){
    show('cleaning');
    const sel=$('cleanEquipment'); if(sel){ sel.value = String(equipId); }
    const t = new Date();
    const pad=(n)=>n.toString().padStart(2,'0');
    const local = `${t.getFullYear()}-${pad(t.getMonth()+1)}-${pad(t.getDate())}T${pad(t.getHours())}:${pad(t.getMinutes())}`;
    $('cleanTime').value = local;
    $('cleanTask').focus();
    location.hash = '#log-cleaning?equipId='+equipId;
  }

  async function checkReminders(){
    await openDB();
    const equipment = await getAll('equipment');
    const now = new Date();
    const keyDate = ymd(now);
    const timeNow = hhmm(now);
    const dayIndex = dow(now);
    const dim = daysInMonth(now.getFullYear(), now.getMonth()+1);
    for(const eq of equipment){
      if(!eq.reminderEnabled) continue;
      for(const s of (eq.schedules||[])){
        let shouldFire=false;
        if(s.type==='weekly'){
          if((s.daysOfWeek||[]).includes(dayIndex) && s.time===timeNow) shouldFire=true;
        }else if(s.type==='monthly'){
          const srcDays = (s.daysOfMonth||[s.dayOfMonth]);
          const adjSet = new Set();
          for(const d of srcDays){
            if(s.autoRollLastDay){ adjSet.add(Math.min(d, dim)); }
            else { adjSet.add(d); }
          }
          if(adjSet.has(now.getDate()) && s.time===timeNow) shouldFire=true;
        }
        if(shouldFire){
          const firedKeys = eq.firedKeys || {};
          const fireKey = `${keyDate}@${timeNow}@${JSON.stringify(s)}`;
          if(!firedKeys[fireKey]){
            try{
              const reg = await navigator.serviceWorker.getRegistration();
              if('Notification' in window && Notification.permission==='granted' && reg){
                reg.showNotification('Cleaning Reminder', {
                  body: `${eq.name}: ${s.type==='weekly'?'Weekly':'Monthly'} at ${timeNow}. Tap to log in Cleaning.`,
                  icon: './assets/icon-192.png',
                  tag: 'equip-'+eq.id+'-'+fireKey,
                  data: { equipId: eq.id }
                });
              }else{
                if(confirm(`Reminder: ${eq.name} (${timeNow}). Log in Cleaning now?`)){
                  gotoCleaningWithEquip(eq.id);
                }
              }
            }catch(e){ console.warn('Notification error', e); }
            eq.firedKeys = Object.assign({}, firedKeys, {[fireKey]: true});
            await put('equipment', eq);
          }
        }
      }
    }
  }

  async function monthlyMismatchWarnings(){
    await openDB();
    const equipment = await getAll('equipment');
    const now = new Date();
    const key = ym(now);
    const dim = daysInMonth(now.getFullYear(), now.getMonth()+1);
    for(const eq of equipment){
      if(!eq.reminderEnabled) continue;
      const taken = eq.monthWarned || {};
      if(taken[key]) continue;
      const offenders = new Set();
      for(const s of (eq.schedules||[])){
        if(s.type==='monthly' && !s.autoRollLastDay){
          for(const d of (s.daysOfMonth||[s.dayOfMonth])){
            if(d>dim) offenders.add(d);
          }
        }
      }
      if(offenders.size){
        try{
          const reg = await navigator.serviceWorker.getRegistration();
          const days = Array.from(offenders).sort((a,b)=>a-b).join(', ');
          const msg = `This month has ${dim} days. ${eq.name} has monthly alarms for ${days} that won't occur. Enable "auto-roll to last day" or add an alternate.`;
          if('Notification' in window && Notification.permission==='granted' && reg){
            reg.showNotification('Monthly alarm won’t occur', {
              body: msg,
              icon: './assets/icon-192.png',
              tag: 'equip-mismatch-'+eq.id+'-'+key,
              data: { equipId: eq.id }
            });
          }else{
            console.warn(msg);
          }
        }catch(e){ console.warn('Warn notification error', e); }
        eq.monthWarned = Object.assign({}, taken, {[key]: true});
        await put('equipment', eq);
      }else{
        eq.monthWarned = Object.assign({}, taken, {[key]: true});
        await put('equipment', eq);
      }
    }
  }

  setInterval(checkReminders, 30000);
  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible'){ checkReminders(); monthlyMismatchWarnings(); } });

  // Hash prefill handler
  function parseHash(){
    try{
      const h=location.hash||'';
      const m=h.match(/#log-cleaning\?equipId=(\d+)/);
      if(m){
        const id=parseInt(m[1],10);
        gotoCleaningWithEquip(id);
      }
    }catch(e){}
  }
  window.addEventListener('hashchange', parseHash);

  function wireAllCombos(){
    wireCombo($('tempStaff'), $('tempStaffList'));
    wireCombo($('cleanStaff'), $('cleanStaffList'));
    wireCombo($('auditStaff'), $('auditStaffList'));
  }

  if('serviceWorker' in navigator && window.isSecureContext && location.protocol !== 'file:' && !/github\.io$/i.test(location.hostname)) { window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js')); } else { console.log('Service Worker disabled (local/insecure or GitHub Pages).'); }openDB()
    .then(()=>{ wireAllCombos(); return loadStaff(); })
    .then(refreshAll)
    .then(()=>{ parseHash(); checkReminders(); monthlyMismatchWarnings(); checkNavFit(); });
  
    // === Non-destructive toast/error helpers (appended) ===
    (function(){
      const toastEl=document.getElementById('toast');
      function makeToast(type, title, desc, timeout=5200){
        if(!toastEl) return;
        const el=document.createElement('div');
        el.className=`toast-item ${type}`;
        el.innerHTML=`<div class="toast-icon">${type==='error'?'⚠️':type==='success'?'✅':'ℹ️'}</div>
          <div><div class="toast-title">${title||''}</div>${desc?`<div class="toast-desc">${desc}</div>`:''}</div>
          <button class="toast-close" aria-label="Dismiss">✕</button>`;
        el.querySelector('.toast-close').onclick=()=> el.remove();
        toastEl.appendChild(el);
        if(timeout){ setTimeout(()=> el.remove(), timeout); }
        return el;
      }
      window.__toast = { makeToast };

      // Gracefully override window.alert to use a toast (non-breaking)
      const nativeAlert = window.alert;
      window.alert = function(msg){ try{ makeToast('warn','Notice', String(msg)); }catch(e){ nativeAlert(String(msg)); } };

      // Friendly validators (capture phase so we can stop invalid submissions without touching existing code)
      const $=id=>document.getElementById(id);
      const within=(v, min, max)=> (typeof v==='number' && !Number.isNaN(v) && v>=min && v<=max);
      const isHHMM=(s)=> /^\d{1,2}:\d{2}$/.test(s||'');

      function attachValidation(formId, fn){
        const form=$(formId); if(!form) return;
        form.setAttribute('novalidate','true');
        form.addEventListener('submit', (e)=>{
          try{
            if(fn && fn()===false){
              e.preventDefault();
              e.stopImmediatePropagation();
            }
          }catch(err){
            makeToast('error','Couldn’t submit', 'Please try again.');
          }
        }, true); // capture
      }

      function validateTemp(){
        const item=$('tempItem'); const value=$('tempValue');
        if(!item || !value) return true; // don’t block if fields aren’t present
        const itemVal=(item.value||'').trim();
        const num = parseFloat(value.value);
        if(!itemVal){ makeToast('error','Missing information','Please enter the food/location.'); return false; }
        if(!within(num, 0, 300)){ makeToast('error','Temperature looks off','Enter a value between 0 and 300 °F.'); return false; }
        const t=($('tempTime') && $('tempTime').value); if(t && Number.isNaN(Date.parse(t))){ makeToast('error','Invalid date/time','Please pick a valid time.'); return false; }
        return true;
      }
      function validateClean(){
        const task=$('cleanTask'); if(!task) return true;
        if(!(task.value||'').trim()){ makeToast('error','Missing task','Please describe the cleaning/sanitizing task.'); return false; }
        return true;
      }
      function validateAudit(){
        const t=$('auditType'); if(!t) return true;
        if(!(t.value||'').trim()){ makeToast('error','Missing type','Please enter an audit/inspection type.'); return false; }
        const time=($('auditTime') && $('auditTime').value); if(time && Number.isNaN(Date.parse(time))){ makeToast('error','Invalid date/time','Please pick a valid time.'); return false; }
        return true;
      }

      // Attach (won’t throw if forms are renamed/missing)
      attachValidation('tempForm', validateTemp);
      attachValidation('cleanForm', validateClean);
      attachValidation('auditForm', validateAudit);

      // Backup import enhancements (wrap file input handler if present)
      const restoreInput = document.getElementById('restoreFile');
      if(restoreInput){
        restoreInput.addEventListener('change', async (e)=>{
          const file=e.target.files?.[0];
          if(!file){ makeToast('warn','No file selected','Choose a backup JSON exported by this app.'); return; }
          try{
            const text = await file.text();
            try{ JSON.parse(text); } catch(parseErr){ makeToast('error','Import failed','That doesn’t look like valid JSON.'); }
          }catch(err){ makeToast('error','Import failed','Couldn’t read the file.'); }
        }, false);
      }
    })();
    // === Feedback (Netlify auto-send) v21 ===
    (function(){
      const FEEDBACK_ENDPOINT = "/.netlify/functions/feedback";
      const TO_EMAIL = "isaac.guthrie05@gmail.com";
      const APP_NAME = "Lhyst";
      const FIXED_SUBJECT = "Feedback";
      const $ = (id)=> document.getElementById(id);

      function addNavFeedback(){
        const nav = document.getElementById('menuWrap') || document.querySelector('header nav') || document.querySelector('header');
        const btn = document.createElement('button');
        btn.className = 'btn nav-feedback';
        btn.id = 'openFeedbackBtn';
        btn.textContent = 'Feedback';
        btn.type = 'button';
        btn.addEventListener('click', openModal);
        if(nav) nav.appendChild(btn);
        else{
          const fab=document.createElement('button');
          fab.className='btn primary feedback-fab';
          fab.textContent='Feedback';
          fab.type='button';
          fab.addEventListener('click', openModal);
          document.body.appendChild(fab);
        }
      }

      function openModal(){ $('feedbackModal')?.classList.remove('hidden'); }
      function closeModal(){ $('feedbackModal')?.classList.add('hidden'); }

      function collect(){
        const data = {
          category: $('fbCategory').value,
          urgency:  $('fbUrgency').value,
          name:     ($('fbName').value||'').trim(),
          email:    ($('fbEmail').value||'').trim(),
          subject:  "Feedback",
          message:  ($('fbMessage').value||'').trim(),
          includeEnv: $('fbIncludeEnv').checked,
          includeURL: $('fbIncludeURL').checked,
        };
        const lines = [];
        lines.push(`App: ${APP_NAME}`);
        lines.push(`Category: ${data.category}`);
        lines.push(`Urgency: ${data.urgency}`);
        lines.push('');
        lines.push('Details:');
        lines.push(data.message);
        lines.push('');
        lines.push('---- Context ----');
        lines.push(`Version: v21`);
        lines.push(`Time: ${new Date().toISOString()}`);
        if(data.includeURL) lines.push(`Page: ${location.href}`);
        if(data.includeEnv){
          lines.push(`User Agent: ${navigator.userAgent}`);
          lines.push(`Viewport: ${window.innerWidth}x${window.innerHeight}`);
          try{ lines.push(`Platform: ${navigator.platform||''}`); }catch(e){}
        }
        if(data.name) lines.push(`Reporter: ${data.name}`);
        if(data.email) lines.push(`Reply-to (provided): ${data.email}`);
        data.body = lines.join('\n');
        return data;
      }

      async function sendFeedback(e){
        e.preventDefault();
        const subject = "Feedback";
        const message = ($('fbMessage').value||'').trim();
        if(!message){
          (window.__toast?.makeToast||alert)('error','Missing details','Please describe the issue or idea.'); return;
        }
        const data = collect();
        try{
          const res = await fetch(FEEDBACK_ENDPOINT, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
              to: TO_EMAIL,
              subject: subject,
              body: data.body,
              from: data.email || undefined,
              name: data.name || undefined
            })
          });
          if(res.ok){
            (window.__toast?.makeToast||alert)('success','Feedback sent','Thanks! We received your feedback.');
            closeModal();
          }else{
            const t = await res.text();
            (window.__toast?.makeToast||alert)('error','Couldn’t send feedback', t || 'Please try again later.');
          }
        }catch(err){
          (window.__toast?.makeToast||alert)('error','Network error','Please check your connection and try again.');
        }
      }

      window.addEventListener('DOMContentLoaded', ()=>{
        addNavFeedback();
        const fm = document.getElementById('feedbackForm');
        const modal = document.getElementById('feedbackModal');
        document.getElementById('feedbackClose')?.addEventListener('click', closeModal);
        document.getElementById('fbCancel')?.addEventListener('click', closeModal);
        fm?.addEventListener('submit', sendFeedback);
        modal?.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });
      });
    })();
    // === Robust placeholders (v23) ===
    (function(){
      function ensureTablePlaceholders(tbody, colCount, minRows){
        if(!tbody) return;
        if(tbody.dataset.phUpdating === '1') return;
        tbody.dataset.phUpdating = '1';
        try{
          var real = tbody.querySelectorAll('tr:not(.placeholder)').length;
          var olds = tbody.querySelectorAll('tr.placeholder');
          for(var i=0;i<olds.length;i++){ olds[i].remove(); }
          var need = Math.max(0, minRows - real);
          for(var r=0;r<need;r++){
            var tr = document.createElement('tr');
            tr.className = 'placeholder';
            var cells = '';
            for(var c=0;c<colCount;c++){ cells += '<td><span class="ph"></span></td>'; }
            tr.innerHTML = cells;
            tbody.appendChild(tr);
          }
        } finally { delete tbody.dataset.phUpdating; }
      }
      function attach(selector, cols, min){
        var tbody = document.querySelector(selector+' tbody');
        if(!tbody) return;
        if(tbody.dataset.phObserved==='1') return;
        var pending=false;
        var run=function(){
          if(pending) return; pending=true;
          requestAnimationFrame(function(){ pending=false; ensureTablePlaceholders(tbody, cols, min); });
        };
        var mo=new MutationObserver(run);
        mo.observe(tbody,{childList:true});
        run(); setTimeout(run, 200); setTimeout(run, 800);
        tbody.dataset.phObserved='1';
      }
      function wait(selector, cols, min){
        if(document.querySelector(selector+' tbody')){ attach(selector, cols, min); return; }
        var mo=new MutationObserver(function(){
          if(document.querySelector(selector+' tbody')){ attach(selector, cols, min); mo.disconnect(); }
        });
        mo.observe(document.body,{childList:true,subtree:true});
      }
      window.addEventListener('DOMContentLoaded', function(){
        wait('#recentTable',4,8);
        wait('#tempsTable',7,6);
        wait('#cleanTable',6,6);
        wait('#auditTable',6,6);
        wait('#equipTable',4,6);
        wait('#staffTable',3,6);
        function wrap(name, sel, cols, min){
          try{
            var fn=window[name]; if(typeof fn!=='function'||fn.__phWrapped) return;
            window[name]=async function(){ var r=await fn.apply(this, arguments); var tb=document.querySelector(sel+' tbody'); ensureTablePlaceholders(tb, cols, min); return r; };
            window[name].__phWrapped=true;
          }catch(e){}
        }
        wrap('refreshRecent','#recentTable',4,8);
        wrap('refreshTemps','#tempsTable',7,6);
        wrap('refreshCleaning','#cleanTable',6,6);
        wrap('refreshAudits','#auditTable',6,6);
        wrap('refreshEquipment','#equipTable',4,6);
        wrap('refreshStaff','#staffTable',3,6);
        setTimeout(function(){
          [['#recentTable',4,8],['#tempsTable',7,6],['#cleanTable',6,6],['#auditTable',6,6],['#equipTable',4,6],['#staffTable',3,6]].forEach(function(cfg){
            var tb=document.querySelector(cfg[0]+' tbody'); ensureTablePlaceholders(tb, cfg[1], cfg[2]);
          });
        }, 1200);
      });
    })();

    // === Lhyst Feedback (Netlify auto-send, fixed subject) v24 ===
    (function(){
      const $ = (id)=> document.getElementById(id);
      const ENDPOINT = "/.netlify/functions/feedback";
      const TO = "isaac.guthrie05@gmail.com";
      const SUBJECT = "Feedback";
      function openModal(){ $('feedbackModal')?.classList.remove('hidden'); }
      function closeModal(){ $('feedbackModal')?.classList.add('hidden'); }
      function ensureFAB(){
        if(!document.querySelector('.feedback-fab')){
          const fab=document.createElement('button');
          fab.className='btn primary feedback-fab';
          fab.textContent='Feedback';
          fab.type='button';
          fab.addEventListener('click', openModal);
          document.body.appendChild(fab);
        }
      }
      function collect(){
        const lines = [];
        lines.push("App: Lhyst");
        lines.push("Category: "+($('fbCategory')?.value||''));
        lines.push("Urgency: "+($('fbUrgency')?.value||''));
        lines.push("");
        lines.push("Details:");
        lines.push(($('fbMessage')?.value||'').trim());
        lines.push("");
        lines.push("---- Context ----");
        lines.push("Version: v24");
        lines.push("Time: "+new Date().toISOString());
        // Always include environment and URL silently
        try {
          lines.push("Page: "+location.href);
        }catch(e){}
        try {
          lines.push("User Agent: "+navigator.userAgent);
          lines.push("Viewport: "+window.innerWidth+"x"+window.innerHeight);
          lines.push("Platform: "+(navigator.platform||''));
        }catch(e){}
        const name = ($('fbName')?.value||'').trim();
        const email = ($('fbEmail')?.value||'').trim();
        if(name) lines.push("Reporter: "+name);
        if(email) lines.push("Reply-to (provided): "+email);
        return { body: lines.join("\n"), from: email||undefined, name: name||undefined };
      }
      async function onSubmit(e){
        e.preventDefault();
        const msg = ($('fbMessage')?.value||'').trim();
        if(!msg){ (window.__toast?.makeToast||alert)('error','Missing details','Please describe the issue or idea.'); return; }
        const data = collect();
        try{
          const res = await fetch(ENDPOINT, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ to: TO, subject: SUBJECT, body: data.body, from: data.from, name: data.name })
          });
          if(res.ok){
            (window.__toast?.makeToast||alert)('success','Feedback sent','Thanks! We received your feedback.');
            closeModal();
          }else{
            const t = await res.text();
            (window.__toast?.makeToast||alert)('error','Feedback service not connected', t || 'Deploy to Netlify and add email provider env vars.');
          }
        }catch(err){
            (window.__toast?.makeToast||alert)('error','Network error','Please check your connection and try again.');
        }
      }
      window.addEventListener('DOMContentLoaded', ()=>{
        ensureFAB();
        $('feedbackClose')?.addEventListener('click', ()=> $('feedbackModal')?.classList.add('hidden'));
        $('fbCancel')?.addEventListener('click', ()=> $('feedbackModal')?.classList.add('hidden'));
        $('feedbackModal')?.addEventListener('click', (e)=>{ if(e.target===$('feedbackModal')) $('feedbackModal')?.classList.add('hidden'); });
        $('feedbackForm')?.addEventListener('submit', onSubmit);
      });
    })();
</script>

  <!-- Feedback Modal -->
  <div id="feedbackModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="feedbackTitle">
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="feedbackTitle">Send Feedback</h3>
        <button class="modal-close" aria-label="Close" id="feedbackClose">✕</button>
      </div>
      <form id="feedbackForm">
        <div class="grid two">
          <div>
            <label>Category</label>
            <select id="fbCategory" required>
              <option value="Bug">Bug</option>
              <option value="Design">Design</option>
              <option value="Feature">Feature</option>
              <option value="Question">Question</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div>
            <label>Urgency</label>
            <select id="fbUrgency">
              <option>Low</option>
              <option>Normal</option>
              <option>High</option>
              <option>Critical</option>
            </select>
          </div>
        </div>
        <div class="grid two">
          <div>
            <label>Your name (optional)</label>
            <input id="fbName" placeholder="Jane Smith" />
          </div>
          <div>
            <label>Your email (optional)</label>
            <input id="fbEmail" type="email" placeholder="you@example.com" />
          </div>
        </div>
        <div>
          <label>Subject</label>
          <input id="fbSubject" placeholder="Short summary" required />
        </div>
        <div>
          <label>Details</label>
          <textarea id="fbMessage" rows="6" placeholder="Describe the issue or idea..." required></textarea>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn subtle" id="fbCancel">Cancel</button>
          <button type="submit" class="btn primary">Send</button>
        </div>
        
      </form>
    </div>
  </div>

  <!-- Signup/Trial gating overlay -->
  <div id="signup-overlay" style="display:none; position:fixed; z-index:9999; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.8); color:#fff; display:flex; align-items:center; justify-content:center; flex-direction:column; text-align:center;">
    <h2>Welcome to Lhyst</h2>
    <p>You must create an account to access the app features.</p>
    <div style="margin-top:1rem;">
      <!-- Redirect to dedicated subscribe and login pages instead of opening the modal directly -->
        <button class="btn primary" onclick="window.location.href='subscribe.html'">Sign&nbsp;Up</button>
      <button class="btn" onclick="window.location.href='login.html'">Log&nbsp;In</button>
    </div>
  </div>

  <!-- Terms of Service Modal -->
  <div id="tos-modal" style="display:none; position:fixed; z-index:9999; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.8); color:#fff; overflow-y:auto;">
    <div style="max-width:600px; margin:5% auto; background:#1e1e1e; padding:2rem; border-radius:8px;">
      <h2>Terms of Service Updated</h2>
      <p>Our terms of service have changed. Please read and accept the latest version to continue using Lhyst.</p>
      <p>By clicking "Accept", you agree to the updated terms and acknowledge any changes in pricing and rules.</p>
      <div style="text-align:right; margin-top:1rem;">
        <button class="btn primary" onclick="acceptTOS()">Accept</button>
      </div>
    </div>
  </div>

  <!-- Payment Required Modal -->
  <div id="payment-modal" style="display:none; position:fixed; z-index:9999; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.8); color:#fff;">
    <div style="max-width:600px; margin:5% auto; background:#1e1e1e; padding:2rem; border-radius:8px;">
      <h2>Trial Ending Soon</h2>
      <p>Your 14‑day trial is almost over. To continue using Lhyst, please choose a subscription plan and enter your payment details.</p>
      <div style="margin-top:1rem; display:flex; gap:0.5rem; flex-wrap:wrap;">
        <button class="btn primary" onclick="subscribe('monthly')">Subscribe Monthly ($9.99/mo)</button>
        <button class="btn primary" onclick="subscribe('yearly')">Subscribe Yearly ($8.99/mo, billed annually)</button>
      </div>
    </div>
  </div>

  <!-- Include Netlify Identity widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <script>
    (function() {
      const TOS_VERSION = 1; // increment this whenever terms or pricing change

      function daysBetween(d1, d2) {
        return Math.floor((d2 - d1) / (24*60*60*1000));
      }

      // Expose functions to global scope for buttons
      window.openSignup = function() {
        if (window.netlifyIdentity) netlifyIdentity.open('signup');
      }
      window.openLogin = function() {
        if (window.netlifyIdentity) netlifyIdentity.open('login');
      }
      window.acceptTOS = function() {
        localStorage.setItem('tosAccepted', TOS_VERSION.toString());
        document.getElementById('tos-modal').style.display = 'none';
        checkTrial();
      }
      window.subscribe = async function(plan) {
        try {
          const res = await fetch('/.netlify/functions/create-checkout-session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ plan })
          });
          const data = await res.json();
          if (data.url) {
            // store that payment has been initiated; actual payment completion will update Stripe
            localStorage.setItem('paymentPending', 'true');
            window.location.href = data.url;
          } else {
            alert(data.error || 'Unable to start subscription');
          }
        } catch (err) {
          console.error(err);
          alert('Error starting subscription');
        }
      }

      function checkTOS() {
        const accepted = parseInt(localStorage.getItem('tosAccepted') || '0', 10);
        if (accepted < TOS_VERSION) {
          document.getElementById('tos-modal').style.display = 'block';
          return false;
        }
        return true;
      }

      function checkTrial() {
        const trialStartStr = localStorage.getItem('trialStart');
        const payment = localStorage.getItem('paymentGiven');
        if (!trialStartStr) return; // no trial started yet
        const trialStart = new Date(trialStartStr);
        const now = new Date();
        const days = daysBetween(trialStart, now);
        // After 10 days, if no payment, show payment modal
        if (!payment && days >= 10) {
          document.getElementById('payment-modal').style.display = 'block';
        }
      }

      // Initialize Netlify Identity and gating logic
      document.addEventListener('DOMContentLoaded', () => {
        const signupOverlay = document.getElementById('signup-overlay');

        if (window.netlifyIdentity) {
          netlifyIdentity.on('init', user => {
            if (!user) {
              signupOverlay.style.display = 'flex';
            } else {
              // user logged in
              signupOverlay.style.display = 'none';
              // if trial not started, set start date
              if (!localStorage.getItem('trialStart')) {
                localStorage.setItem('trialStart', new Date().toISOString());
              }
              // Check TOS and trial status
              if (checkTOS()) {
                checkTrial();
              }
            }
          });
          netlifyIdentity.on('login', user => {
            signupOverlay.style.display = 'none';
            // start trial if not already started
            if (!localStorage.getItem('trialStart')) {
              localStorage.setItem('trialStart', new Date().toISOString());
            }
            if (checkTOS()) {
              checkTrial();
            }
          });
          netlifyIdentity.on('logout', () => {
            signupOverlay.style.display = 'flex';
          });
          netlifyIdentity.init();
        } else {
          console.warn('Netlify Identity not available');
        }
      });
    })();
  </script>

</body>
</html>
